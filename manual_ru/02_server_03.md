# Эволюция игрового фреймворка. Сервер 3. Сеть (Временно пропущенно)

Черновик

## Физический уровень

Начну с самого начала. можно пропустить, можно читать с конца. даже если большая часть материала уже вам известна, все равно нелишним будет кое-что повторить — чтобы систематизировать знания или, по меньшей мере, договориться о терминологии.

Что касается подробности, то кто-то может возразить: зачем влезать в такие дебри? Ведь нам на практике нужно знать только самую вершину айсберга всех этих знаний, а на все, что лежит под ней, мы даже повлиять никак не можем. Все это, конечно, верно. Но пока все идет как надо. Когда же возникают проблемы и неполадки, нам хорошо бы уметь определить их источник и способы их преодоления, а тут уж без понимания и умения представить работу всей системы не обойтись. Причем знать желательно вплоть до того, как движутся электроны по проводам, и что им в этом может помешать. Также нужно понимать, как система формировалась и почему она именно такая, а не другая. Именно такое исчерпывающе полное и логически стройное знание, где каждое новое понятие необходимо вытекает из предыдущего, и называется системным. К сожалению, задача эта грандиозная и для меня неподъемная, но попытаться тут сделать общий набросок никто ведь не запретит.

todo изменение, колебание, сигнал, модуляция, бит, поток битов, байт (октет), скорость бит/сек (байты исп. только при хранении, т.к. байт=ячейка - мин. единица памяти, бит - мин ед. инф. при передаче),
todo передача сигнала, звук, свет, радио, электричество, один и два провода, постоянный ток, переменный, телеграфный провод, коаксиальная линия, витая пара, почему именно витая
радио-телевидение-телетекст - симплексная связь
телеграф-телефон/радио-видеотекс-интернет - полудуплексная-дуплексная связь

Простейшая компьютерная сеть — это две машины, соединенные проводом. Как известно все данные в ЭВМ представлены в виде электрического сигнала. Но такой сигнал, который используется внутри компьютера, где расстояния маленькие, будет быстро затухать при больших расстояниях, так что уже через пару метров нельзя будет достоверно отличить 0 от 1. Поэтому требуется преобразователь сигнала. Постоянный ток преобразуется в переменный ток высокой частоты. Так появляется сетевой адаптер, или сетевая плата (карта) (NIC — network interface controller). С точки зрения компьютера сетевая плата — это одно из устройств ввода-вывода, на ряду с монитором, клавиатурой, принтером и другими.

Чтобы уменьшить влияние помех внешней среды и посторонних электро-магнитных полей провод изолируется диэлектриком и может иногда экранироваться металлической оплеткой. Такая защищенная линия передачи называется кабелем. Однако, и такая линия передачи сигналов имеет свои ограничения по расстоянию. Чтобы усилить затухающий сигнал, требуется специальное устройство повторитель (repeater), имеющий два разъема-порта. Один порт соединен с первой машиной, другой — со второй. Заметим также, что разъем и порт — это одно и то же; первое — это с точки зрения физического устройства, и второе — с логической, как часть общей компьютерной системы.

Нельзя одновременно передавать и получать информацию по одной и той же линии связи. Мы просто не отличим один сигнал от другого. В качестве решения, можно передавать сигналы по очереди, но мы тем самым уменьшаем скорость передачи минимум вдвое. (Такая связь называется полудуплексной.) А можно добавить еще одну линию, использовать разные частоты на прием и передачу, и тогда информацию можно передавать в обе стороны одновременно. (Такая связь называется дуплексной. Есть еще симплексная связь, где информация передается только в одном направлении, как в телевидении или при радиовещании.) Каждый такой провод или частота составляют канал передачи сигналов. Проблема в том, что мы не можем добавлять новый канал для каждого нового подключения, так как их может быть сотни, тысячи, миллионы.

Пока что у нас только два узла, соединенные проводом. Но этого мало. Как соединить, например, три машины? Есть два решения: добавить еще по одной сетевой плате и кабелю между ними, но тогда уже после 5 новых подключений сетевые карты некуда будет вставлять. Куда лучше добавить в повторитель дополнительные порты для новых абонентов и тем превратить повторитель (repeater) в концентратор (hub). Отличие между ними только в том, что повторитель передает данные только в один порт, а концентратор в несколько — во все, к которым подключены устройства.

Но как получателям отделять свои данные от чужих? Тут нам понадобятся идентификаторы для каждого узла сети — MAC-адреса (MAC address — media access control). Вместе с данными, нужно передавать и адрес узла, которому эти данные предназначаются.

Теперь встает другой вопрос: как отделить в сплошном потоке битов биты, кодирующие адрес, от битов, кодирующих полезную информацию? Для этого нужно разбить сплошной поток битов на кадры (frame). Каждый кадр будет начинаться с 7-байтной преамбулы: 10101010 10101010 10101010 10101010 10101010 10101010 10101010, которая позволит нам обнаружить начало кадра, а также синхронизировать тактовый генератор принимающего устройства. После этого идет 1 байт разделителя: 10101011, означающего, что далее идет основное тело кадра. Оно начинается с MAC-адреса назначения (destination MAC), далее следует адрес отправителя (source MAC) и тип кадра (EtherType). Вместе эти три поля образуют заголовок кадра. Тип кадра явно (если его значение меньше или равно 1500) или неявно (если значение больше 1535) содержит общую длину кадра, что позволяет нам узнать, где нужно закончить считывать поток битов для данного кадра и начинать для следующего. Также размер кадра косвенно определяет, где заканчиваются биты полезной нагрузки (payload), т.е. собственно основной передаваемой информации.

Последние 4 байта отводится на вычисление контрольной суммы (CRC — Cyclic redundancy check). Так, например, если разбить весь кадр на части по 4 байта, сложить их между собой и записать в конце, а потом сделать то же самое после передачи кадра по линии связи и сравнить с исходной суммой, то если произошла ошибка хотя бы одном бите, эти два значения не совпадут. Однако, суммы могут совпасть при удачном совпадении нескольких ошибок. Но если подобрать алгоритм получше, вероятность этого события будет достаточно мала.

Теперь, когда поток битов разбит на кадры, и каждый кадр содержит адрес, по которому его нужно доставить, остается решить как эта доставка будет осуществляться. Собственно, тут и решать нечего: концентратор (hub) уже доставляет каждый кадр всем подключенным к нему узлам. А на каждом конце уже само устройство смотрит, если адрес назначения (destination MAC) совпадает с собственным MAC-адресом данной машины, то кадр принимается на обработку. Если нет — игнорируется.

Так работает самая распространенная сейчас технология пакетной передачи данных в компьютерных сетях — Ethernet. Само название (букв. "эфирная сеть") отражает его первоначальный принцип сходный с радиовещанием, по которому пакеты данных передаются как будто в эфир, где их может получить кто-угодно, у кого есть приемник.

todo (В результате, мы перешли от коммутации (соединения) каналов к коммутации пакетов.)

Данная схема работы проста, но не лишена серьезных недостатков. Во-первых, нас не устраивает, что передавая данные от одного узла к другому (возможно очень важные и секретные данные), их становятся доступным всем узлам в сети. Во-вторых, одновременно можно передавать только один кадр. А если какой-то другой узел пытается передать свои данные, пока передает другой, то случается коллизия. Его передача отменяется, чтобы попытка повторилась позже через случайный интервал времени. Выходит, что если, допустим, в сети 4 узла: A, B, C и D, то пока A шлет пакет B, C не может послать свой пакет D и вынужден ждать. Это значит, что узлы находятся в общей разделяемой среде передачи — домене коллизий (Collision domain).

## Канальный уровень

todo мост

Вот мы построили небольшую сеть, в которой несколько компьютеров соединены между собой через коммутатор. Допустим у нас есть два этажа и на каждом создана отдельная сеть, todo но по другой технологии и с другой аппаратурой (??????). Чтобы соединить эти две сети нужен мост. Для каждой из сетей мост — это просто еще один узел, на который приходят кадры. По исходящим адресам кадров мост узнает какие адреса существуют в каждой подсети и записывает их в свою ассоциативную память. Так что, когда кадр, пришедший из одной подсети, содержит адрес узла другой подсети, принимается мостом и передается в нужную подсеть, т.к. этот адрес содержится в памяти моста и ассоциирован с соответствующим его портом. Пока же таблица не заполнилась, все кадры пересылаются без ограничений.

Обычно мост имеет два порта, но может содержать и больше, и все они могут быть одного типа. Тогда он он становится неотличим от обычного коммутатора. Поэтому и говорят, что мост — это частный случай коммутатора. Как нам объединить их в одно целое? Если соединить два коммутатора,

Обе проблемы решаются добавлением проверки адресов в концентратор, после чего он перестает быть концентратором (hub) и превращается в коммутатор (switch). Принцип работы коммутатора достаточно прост. В нем содержится таблица коммутации (ассоциативная память), где для каждого порта записывается соответствующий адрес подключенного к нему узла. В начале работы таблица пуста, и тогда каждый поступивший кадр пересылается во все порты, кроме того, откуда он пришел. Но исходящий адрес этого кадра заносится в таблицу. Так, по мере поступления кадров из всех портов таблица коммутации заполняется, и данные начинают поступать только на те узлы, которым они предназначены. Это не только увеличивает безопасность сети, но и скорость передачи сообщений за счет создания отдельного домена коллизий для каждого соединения.

Также в некоторые коммутаторы добавляется проверка на ошибки в кадрах. В простейших случаях проверяется размер кадра: если он меньше минимального значения (64 байт), то кадр отбрасывается. В остальных случаях после прочтения первых 64 байтов поток битов перенаправляется получателю. В более совершенных устройствах проверяется целостность данных по CRC-сумме. Для этого нужно сохранять полностью весь кадр, а после проверки уже либо отбрасывать, либо пересылать по назначению. Все это, разумеется, добавляет задержки на передачу пакетов, но тут уже проектировщикам решать: передавать все сообщения как можно более быстрее, или лучше обнаруживать ошибки на ранних этапах и не нагружать канал передачей битых пакетов.

каскадное соединение коммутаторов
асимметричность
очереди


(В результате, мы перешли от коммутации (соединения) каналов к коммутации пакетов.)

Различать, какие реальные компьютеры кроются за тем или иным MAC-адресом, можно или если знать MAC-адрес компьютеров заранее (сходить к нему и посмотреть) или если информация о компьютере придет в полезной нагрузке кадра — в полученных данных будет написано: я такой-то и такой-то. А как это делается на системном уровне, будет описано дальше.

todo добавить, где и как реализованы все элементы протоколов и технологий

## Сетевой уровень



## Транспортный уровень

##

## Система уровней

физический и канальный слой. независимость слоев, подмена реализации одного слоя не отражается на другом.

## История


Конечно, данное описание работы компьютерных сетей неполное, но, надеюсь, его достаточно, чтобы понять общие принципы их работы. В всяком случае, теперь понятнее будут книги, потому что без все равно никуда. Хоть информация в них и распределена по разделам довольно искусственно, так что порой, чтобы понять начало, нужно прочитать середину. Или и вовсе лучше заранее знать и понимать то, о чем читаешь.

[Физика Ethernet для самых маленьких](https://habr.com/ru/post/158177/)
[Джеймс Ф. Куроуз, Кит В. Росс - Компьютерные сети. Многоуровневая архитектура Интернета (2-е изд., 2004)](https://files.ttuwiki.org/Computer_Networking_second_edition_rus.pdf)
[Глейзер Дж., Мадхав С. - Многопользовательские игры. Разработка сетевых приложений (2017)]()
Олифер В.Г., Олифер Н.А. Компьютерные сети. Принципы, технологии, протоколы
Таненбаум Э., Уэзеролл Д. - Компьютерные сети

[Исходники](https://gitlab.com/markelov-alex/hx-py-framework-evolution/-/tree/main/f_models/)

[< Назад](02_server_02.md)  |  [Начало](00_intro_01.md)  |  [Вперед >](02_server_04.md)
